"""
vulnerability_scanning.py

Container image vulnerability scanning integration.

Prerequisites:
- requests, subprocess
"""

import subprocess
import json
import logging
from typing import Dict, Any, List

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


def scan_with_trivy(image: str) -> Dict[str, Any]:
    """
    Scan a Docker image using Trivy.

    Interview Question:
        Q: What is shift-left security?
        A: Move security checks earlier in the pipeline:
           1. IDE: linting, secret detection
           2. Pre-commit: SAST, dependency scanning
           3. CI pipeline: container scanning, DAST
           4. Registry: admission controller blocks vulnerable images
           5. Runtime: Falco, runtime scanning
           Trivy scans: OS packages, language deps, IaC misconfigs.
    """
    try:
        result = subprocess.run(
            ['trivy', 'image', '--format', 'json', '--quiet', image],
            capture_output=True, text=True, timeout=300
        )
        if result.returncode == 0:
            data = json.loads(result.stdout)
            vulnerabilities = []
            for target in data.get('Results', []):
                for vuln in target.get('Vulnerabilities', []):
                    vulnerabilities.append({
                        'id': vuln.get('VulnerabilityID', ''),
                        'severity': vuln.get('Severity', ''),
                        'package': vuln.get('PkgName', ''),
                        'installed': vuln.get('InstalledVersion', ''),
                        'fixed': vuln.get('FixedVersion', ''),
                        'title': vuln.get('Title', ''),
                    })

            severity_counts = {}
            for v in vulnerabilities:
                sev = v['severity']
                severity_counts[sev] = severity_counts.get(sev, 0) + 1

            return {
                'image': image,
                'total_vulnerabilities': len(vulnerabilities),
                'by_severity': severity_counts,
                'critical': [v for v in vulnerabilities if v['severity'] == 'CRITICAL'],
                'status': 'ok',
            }
        return {'status': 'error', 'output': result.stderr}
    except FileNotFoundError:
        return {'status': 'error', 'error': 'trivy not installed'}
    except Exception as e:
        return {'status': 'error', 'error': str(e)}


def check_scan_policy(
    scan_result: Dict[str, Any],
    max_critical: int = 0,
    max_high: int = 5
) -> Dict[str, Any]:
    """Check if scan results pass policy gates."""
    severity = scan_result.get('by_severity', {})
    critical = severity.get('CRITICAL', 0)
    high = severity.get('HIGH', 0)

    passed = critical <= max_critical and high <= max_high
    return {
        'passed': passed,
        'critical': critical,
        'high': high,
        'reason': '' if passed else f'Critical={critical} (max {max_critical}), High={high} (max {max_high})',
    }


if __name__ == "__main__":
    print("Vulnerability Scanning â€” Usage Examples")
    print("""
    result = scan_with_trivy('nginx:latest')
    print(f"  Total: {result['total_vulnerabilities']}")
    print(f"  Severity: {result['by_severity']}")

    policy = check_scan_policy(result)
    print(f"  Policy: {'PASS' if policy['passed'] else 'FAIL'}")
    """)
